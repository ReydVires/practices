var FMath_selectedElement = null;

tinymce.PluginManager.add('FMathEditor', function (editor, url) {
    'use strict';

    editor.addButton('FMathEditor', {
        text: '',
        image: url + '/icons/FMathEditor.png',

        onclick: function () {
            // Open window
            editor.windowManager.open({
                title: 'FMath Editor - www.fmath.info',
                file: url + '/editor/onlyEditor.html',
                width: 1050,
                id: 'FMathEditorIFrame',
                height: 500,
                buttons: [{
                    text: 'Insert Equation',
                    onclick: function () {
                        var frame = null,
                            frames = document.getElementsByTagName("iframe"),
                            src = "",
                            i = 0,
                            mathml = "",
                            img = null;

                        for (i = 0; i < frames.length; i += 1) {
                            src = frames[i].src;

                            if (src !== null && src.indexOf('onlyEditor.html') > -1) {
                                frame = frames[i];
                                break;
                            }
                        }

                        mathml = frame.contentWindow.getMathML();

                        img = frame.contentWindow.getBlobOrUrl(function (result) {
                            var img = null;

                            if (result.indexOf("ERROR:") === 0) {
                                console.dir(result);
                            } else {
                                img = result;
                                tinymce.activeEditor.insertContent('<img alt="MathML (base64):' + window.btoa(mathml) + '" src="' + img + '"/>');
                                editor.windowManager.close();
                            }
                        });
                    }
                }, {
                    text: 'Close',
                    onclick: 'close'
                }]
            });

        },

        onPostRender: function () {
            var ctrl = this;

            editor.on('NodeChange', function (e) {
                if (e.element.nodeName === 'IMG') {
                    FMath_selectedElement = e.element;
                } else {
                    FMath_selectedElement = null;
                }
            });
        }
    });
});

function getMathMLToLoad () {
    'use strict';
    var alt = null,
        mathml = "";

    console.log("getMathMLToLoad");

    if (FMath_selectedElement !== null) {
        alt = FMath_selectedElement.alt;

        if (alt !== null && alt.indexOf("MathML (base64):") === 0) {
            mathml = alt.substring(16, alt.length);
            console.log(mathml);
            return window.atob(mathml);
        }
    }

    return null;
}