var FMath_selectedElement = null,

    getFrame = function () {
        'use strict';
        var i = 0,
            src = "",
            frame = null,
            frames = document.getElementsByTagName("iframe");

        for (i = 0; i < frames.length; i += 1) {
            src = frames[i].src;

            if (src !== null && src.indexOf('onlyEditor.html') > -1) {
                frame = frames[i];
                break;
            }
        }

        return frame;
    },

    getMathMLToLoad = function () {
        'use strict';
        var alt = null,
            mathml = "";

        console.log("getMathMLToLoad");

        if (FMath_selectedElement !== null) {
            alt = FMath_selectedElement.alt;

            if (alt !== null && alt.indexOf("MathML (base64):") === 0) {
                mathml = alt.substring(16, alt.length);
                console.log(mathml);
                return window.atob(mathml);
            }
        }

        return null;
    };

tinymce.PluginManager.add('FMathEditor', function (editor, url) {
    'use strict';

    editor.on('init', function (e) {
        var img = new Image(),
            canvas = window.parent.document.getElementById('canvas'),
            ctx = canvas.getContext('2d'),
            blob = null,
            base64String = "",
            newImg = new Image(),
            imgTag = document.createElement("img");

        img.onload = function () {
            canvas.width = this.width;
            canvas.height = this.height;
            ctx.drawImage(img, 0, 0);
        };

        img.src = 'img/math.png';

        base64String = canvas.toDataURL('image/png', 1.0);
        newImg.src = base64String;
        console.log(window.btoa(base64String.substring(22, base64String.length)));

        imgTag.src = canvas.toDataURL("image/png", 1.0);
        window.parent.document.body.appendChild(imgTag);

        //editor.insertContent(newImg);//'<img alt="Math" src="' + canvas.toDataURL('image/png', 1.0) + '"/>');
        //editor.insertContent('<img alt="MathML (base64):' + base64String.substring(22, base64String.length) + '" src="' + base64String + '"/>');
        /*blob = canvas.toBlob(function (blob) {
            var newImg = window.parent.document.createElement('img'),
                url = window.URL.createObjectURL(blob);

            newImg.onload = function() {
                // no longer need to read the blob so it's revoked
                window.URL.revokeObjectURL(url);
            };

            newImg.src = url;
            //newImg.alt = "MathML (base64):" +
            window.parent.document.body.appendChild(newImg);
        }, 'image/png', 1.0);*/
    });

    editor.addButton('FMathEditor', {
        text: '',
        image: url + '/icons/FMathEditor.png',
        onclick: function () {
            // Open window
            editor.windowManager.open({
                title: 'FMath Editor - www.fmath.info',
                file: url + '/editor/onlyEditor.html',
                width: 1050,
                id: 'FMathEditorIFrame',
                height: 500,
                buttons: [{
                    text: 'Insert Equation',
                    onclick: function () {
                        var frame = getFrame(),
                            src = "",
                            i = 0,
                            mathml = "",
                            img = null;

                        mathml = frame.contentWindow.getMathML();

                        img = frame.contentWindow.getBlobOrUrl(function (result) {
                            var img = null;

                            if (result.indexOf("ERROR:") === 0) {
                                console.dir(result);
                            } else {
                                img = result;
                                tinymce.activeEditor.insertContent('<img alt="MathML (base64):' + window.btoa(mathml) + '" src="' + img + '"/>');
                                editor.windowManager.close();
                            }
                        });
                    }
                }, {
                    text: 'Close',
                    onclick: 'close'
                }]
            });

        },

        onPostRender: function () {
            var ctrl = this;

            editor.on('NodeChange', function (e) {
                if (e.element.nodeName === 'IMG') {
                    FMath_selectedElement = e.element;
                } else {
                    FMath_selectedElement = null;
                }
            });
        }
    });
});